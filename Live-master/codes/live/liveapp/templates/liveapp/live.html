{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}{{ Live.roomName }}{% endblock %} 
{% block css %} <link href="{% static 'css/video-js.min.css' %}" rel="stylesheet">{% endblock %}

{% block content %}



<div class="container" style="background-color: aliceblue;">
    <label style="margin-left:5%;font-size: 17px;color: darkblue;">主讲人：{{ Live.creater }}</label>
    <label style="margin-left:28%;font-size: 17px;color: darkblue;">房间号：{{ Live.roomId }}</label>
    <div class="col-md-8">
        <video id="rtmpVideo" class="video-js" controls preload="auto" width="640" height="264" data-setup='{ "html5" : { "nativeTextTracks" : false } }'>
        </video>

        <script src="{% static 'js/video.min.js' %}"></script>
        <script src="{% static 'js/videojs-flash.min.js' %}"></script>
        <script type="text/javascript">
            //设置中文
            videojs.options.flash.swf = '{% static 'js/video-js.swf' %}';

            // 初始化视频，设为全局变量
            var myPlayer = videojs('rtmpVideo', {
                autoplay: true,
                controls: true, //控制条

                muted: true, // 静音
                preload: "auto", // 预加载
                language: "zh-CN", // 初始化语言
                playbackRates: [1, 2, 3, 4, 5, 8, 10, 20], // 播放速度
                'techOrder': ['flash'],

                sources: [{
                    src: 'rtmp://localhost:1935/live/{{ Live.roomId }}', //这里设置你的播放资源，
                    type: 'rtmp/flv'
                }]
            }, function() {
                console.log("--------------成功初始化视频--------------");
                myPlayer.one("playing", function() { // 监听播放
                    console.log("开始播放");
                });
                myPlayer.one("error", function(error) { // 监听错误
                    console.error("监听到异常，错误信息：%o", error);
                });
            });
        </script>

        {% if is_main %}
        <div>
            <form action="/opencamera/" method="post">
                {% csrf_token %}
                <button type="submit" style="height: 50px;background-color: beige;text-align: center;line-height: 50px;float: left;width: 100px;margin-left: 15%;">打开视频声音</button>
            </form>

            <form action="/openShareScreen/" method="post">
                {% csrf_token %}
                <button type="submit" style="height: 50px;background-color: beige;text-align: center;line-height: 50px;float: left;width: 100px;">打开屏幕共享</button>
            </form>
            <form action="/closecamera/" method="post">
                {% csrf_token %}
                <button type="submit" style="height: 50px;background-color: beige;text-align: center;line-height: 50px;float: left;width: 100px;">关闭视频</button>
            </form>
            <form action="/closelive/" method="post" id="{{ Live.roomId }}">
                {% csrf_token %}
                <button type="submit" style="height: 50px;background-color: beige;text-align: center;line-height: 50px;float: left;width: 100px;">关闭直播</button>
            </form>
        </div>
        {% endif %}
    </div>
    <div class="col-md-3" style="text-align: center;">
        <textarea id="chat-log" cols="35" rows="15"></textarea><br/>
        <input id="chat-message-input" type="text" size="33px" placeholder="edit message at here..." style="float: left;" />
        <input id="chat-message-submit" type="button" value="Send" style="margin-left: 85%;width:60px;background-color: beige;" />
    </div>
</div>

<div>
</div>

<script>
    var roomName = '{{ pk }}';

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/live/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        document.querySelector('#chat-log').value += (message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) { // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        message = '{{ username }}: ' + message;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>

{% endblock %}